<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nöbet Fiyat</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK'ları -->
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-firestore.js"></script>
    <script>
        // Firebase yapılandırma bilgilerinizi buraya ekleyin
        const firebaseConfig = {
            apiKey: "AIzaSyC035yNDCY-LKV_NHXxdDaJBcPM_HY_zW4",
            authDomain: "nobettakip-447bf.firebaseapp.com",
            projectId: "nobettakip-447bf",
            storageBucket: "nobettakip-447bf.appspot.com",
            messagingSenderId: "685407754980",
            appId: "1:685407754980:web:5e63808d0c36186afbaaf1",
            measurementId: "G-N36D0ST83P"
        };

        // Firebase'i başlat
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const pricesRef = db.collection('prices');

        // DOM elemanlarını seç
        const priceForm = document.getElementById('priceForm');
        const priceList = document.getElementById('priceList');
        const averagePriceElement = document.getElementById('averagePrice');
        const resetButton = document.getElementById('resetButton');
        const resetPassword = document.getElementById('resetPassword');
        const messageElement = document.getElementById('message');
        const correctPassword = '79066540'; // Sıfırlama şifresi

        // Sayfa yüklendiğinde fiyatları göster
        renderPrices();

        function renderPrices() {
            priceList.innerHTML = '';
            pricesRef.get().then(snapshot => {
                snapshot.forEach(doc => {
                    const priceEntry = doc.data();
                    const listItem = document.createElement('li');
                    listItem.textContent = `${priceEntry.stock} - ${priceEntry.date}: ${priceEntry.price.toFixed(2)} TL`;
                    priceList.appendChild(listItem);
                });
                updateAveragePrice();
            }).catch(error => {
                console.error("Fiyatları yüklerken hata: ", error);
            });
        }

        priceForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const stock = document.getElementById('stock').value;
            const date = document.getElementById('date').value; 
            const price = parseFloat(document.getElementById('price').value);

            console.log('Stock:', stock);
            console.log('Date:', date);
            console.log('Price:', price);

            // Hataları kontrol et
            if (!stock || !date || isNaN(price) || price <= 0) {
                console.error("Form verileri geçersiz.");
                alert("Lütfen tüm alanları doldurduğunuzdan emin olun.");
                return;
            }

            const priceEntry = { stock, date, price };

            pricesRef.add(priceEntry).then(() => {
                renderPrices();
                messageElement.textContent = "Başarıyla eklendi.";
                setTimeout(() => messageElement.textContent = '', 3000);
            }).catch(error => {
                console.error("Hata eklerken: ", error);
                alert("Bir hata oluştu: " + error.message);
            });
        });

        // Tarih alanına otomatik / ekleme
        const dateInput = document.getElementById('date');
        dateInput.addEventListener('input', function(event) {
            let value = dateInput.value.replace(/[^0-9]/g, ''); // Sadece rakamları al
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2); // gg/aa formatı
            }
            if (value.length >= 5) {
                value = value.slice(0, 5) + '/' + value.slice(5); // gg/aa/yyyy formatı
            }
            dateInput.value = value; // Güncellenmiş değeri inputa yaz
        });

        resetButton.addEventListener('click', function() {
            const enteredPassword = resetPassword.value;

            if (enteredPassword === correctPassword) {
                pricesRef.get().then(snapshot => {
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                }).then(() => {
                    renderPrices();
                    alert('Geçmiş sıfırlandı.');
                    resetPassword.value = '';
                }).catch(error => {
                    console.error("Geçmiş sıfırlanırken hata: ", error);
                    alert("Geçmişi sıfırlarken hata oluştu.");
                });
            } else {
                alert('Yanlış şifre. Lütfen tekrar deneyin.');
            }
        });

        function updateAveragePrice() {
            pricesRef.get().then(snapshot => {
                const prices = snapshot.docs.map(doc => doc.data().price);
                const total = prices.reduce((sum, price) => sum + price, 0);
                const average = prices.length ? total / prices.length : 0;
                averagePriceElement.textContent = average.toFixed(2);
            }).catch(error => {
                console.error("Ortalama fiyat hesaplanırken hata: ", error);
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Nöbet Fiyat</h1>
        <form id="priceForm">
            <label for="stock">Servis Seç:</label>
            <select id="stock" required>
                <option value="Acil">Acil</option>
                <option value="Acil (24 saat)">Acil (24 saat)</option>
                <option value="Pediatri">Pediatri</option>
                <option value="Pediatri (24 saat)">Pediatri (24 saat)</option>
                <option value="Genel Cerrahi">Genel Cerrahi</option>
                <option value="Genel Cerrahi (24 saat)">Genel Cerrahi (24 saat)</option>
                <option value="Dahiliye">Dahiliye</option>
                <option value="Dahiliye (24 saat)">Dahiliye (24 saat)</option>
                <option value="Kadın Doğum">Kadın Doğum</option>
                <option value="Kadın Doğum (24 saat)">Kadın Doğum (24 saat)</option>
                <option value="Seçmeli">Seçmeli</option>
                <option value="Seçmeli (24 saat)">Seçmeli (24 saat)</option>
            </select>

            <label for="date">Tarih (gg/aa/yyyy):</label>
            <input type="text" id="date" placeholder="dd/mm/yyyy" required>

            <label for="price">Fiyat:</label>
            <input type="number" id="price" step="0.01" required>

            <button type="submit">Ekle</button>
        </form>

        <h2>Geçmişi Sıfırlama</h2>
        <label for="resetPassword">Şifre:</label>
        <input type="password" id="resetPassword" placeholder="Şifre girin">
        <button id="resetButton">Geçmişi Sıfırla</button>

        <h2>Girdiğiniz Fiyatlar:</h2>
        <ul id="priceList"></ul>

        <h2>Ortalama Fiyat:</h2>
        <p id="averagePrice">0.00</p>

        <p id="message" style="color: green;"></p> <!-- Başarı mesajı için alan -->
    </div>
</body>
</html>
